/*TẠO DATABASE*/
CREATE DATABASE QLSVIEN
USE QLSVIEN
GO 
--TẠO BẢNG
USE QLSVIEN
CREATE TABLE KHOA
(
	MAKHOA VARCHAR(10) NOT NULL,
	TENKHOA NVARCHAR(50) NOT NULL,
	NAMTHANHLAP INT,
	CONSTRAINT PK_KHOA PRIMARY KEY (MAKHOA),
	CONSTRAINT UN_TENKHOA UNIQUE (TENKHOA)
)
GO
-- XÓA BẢNG
DROP TABLE KHOA
--TẠO BẢNG SINHVIEN
CREATE TABLE SINHVIEN
(
	MASV VARCHAR(15) NOT NULL,
	TENSV NVARCHAR(50) NOT NULL,
	NAM INT DEFAULT 1,
	MAKHOA VARCHAR(10),
	CONSTRAINT PK_SINHVIEN PRIMARY KEY (MASV),
	CONSTRAINT FK_SV_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
	CONSTRAINT CHK_NAM CHECK (NAM IN (1,2,3,4))
)
GO
CREATE TABLE MONHOC
(
	MAMH VARCHAR(10) NOT NULL,
	TENMH NVARCHAR(50) NOT NULL,
	TINCHI INT,
	MAKHOA VARCHAR(10),
	CONSTRAINT PK_MONHOC PRIMARY KEY(MAMH),
	CONSTRAINT FK_MONHOC_KHOA FOREIGN KEY (MAKHOA) REFERENCES KHOA(MAKHOA),
	CONSTRAINT UN_TENMH UNIQUE (TENMH),
	CONSTRAINT CHK_TINCHI CHECK (TINCHI>=1 AND TINCHI<=6)
)
GO
ALTER TABLE MONHOC ALTER COLUMN MAKHOA VARCHAR(10) NOT NULL
CREATE TABLE HOCPHAN
(
	MAHP VARCHAR(10) NOT NULL,
	HOCKY INT DEFAULT 1,
	NAMHOC INT,
	GIAOVIEN NVARCHAR(50),
	MAMH VARCHAR(10),
	CONSTRAINT PK_HOCPHAN PRIMARY KEY(MAHP),
	CONSTRAINT FK_HP_MONHOC FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH)
)
ALTER TABLE HOCPHAN ALTER COLUMN MAMH VARCHAR(10) NOT NULL
GO
--THÊM KHÓA NGOẠI
ALTER TABLE MONHOC ADD CONSTRAINT FK_HP_MONHOC FOREIGN KEY(MAMH) REFERENCES MONHOC(MAMH)
GO

CREATE TABLE DIEUKIEN
(
	MAMH VARCHAR(10) NOT NULL,
	MAMH_TRUOC VARCHAR(10) NOT NULL,
	CONSTRAINT PK_DIEUKIEN PRIMARY KEY (MAMH,MAMH_TRUOC),
	CONSTRAINT FK_DK_MONHOC FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),
	CONSTRAINT FK_DK_MONHOCTRUOC FOREIGN KEY (MAMH_TRUOC) REFERENCES MONHOC(MAMH)
)
GO
CREATE TABLE KETQUA
(
	MASV VARCHAR(15) NOT NULL,
	MAHP VARCHAR(10) NOT NULL,
	DIEM REAL,
	CONSTRAINT PK_KQUA PRIMARY KEY(MASV,MAHP),
	CONSTRAINT FK_KQ1 FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
	CONSTRAINT FK_KQ2 FOREIGN KEY (MAHP) REFERENCES HOCPHAN(MAHP)
)
GO
DROP TABLE KETQUA
ALTER TABLE KETQUA ADD CONSTRAINT CHK_DIEM CHECK (DIEM>=0 AND DIEM<=10)

--NHẬP DỮ LIỆU BẢNG KHOA
SELECT * FROM KHOA
INSERT INTO KHOA
VALUES ('TKTH',N'Thống kê tin học',2005),
('KT',N'Kế toán',1994),
('MKT',N'Marketing',2001),
('DL',N'Du lịch',2012),
('QTKD',N'Quản trị kinh doanh',1992)
go
--Nhập dữ liệu bảng sinh viên
SELECT * FROM SINHVIEN
INSERT INTO SINHVIEN
VALUES ('SV001',N'Trần Lệ Quyên',2,'TKTH','2003-01-21'),
('SV002',N'Nguyễn Thế Bình',3,'MKT','2002-06-01'),
('SV003',N'Tô Ánh Nguyệt',2,'TKTH','2003-05-02'),
('SV004',N'Nguyễn Thế Anh',2,'DL','2003-12-15'),
('SV005',N'Lê Thanh Bình',2,'KT','2003-12-09'),
('SV006',N'Phạm Quang Hậu',3,'TKTH','2003-10-12'),
('SV007',N'Lê Cẩm Tú',4,'MKT','2001-02-13'),
('SV008',N'Trương Thế Sang',4,'MKT','2001-04-04'),
('SV009',N'Đậu Quang Ánh',3,'TKTH','2002-12-03'),
('SV010',N'Huỳnh Kim Chi',2,'KT','2003-10-18'),
('SV011',N'Trinh Đình Ánh',3,'QTKD','2002-11-15')

-- NHẬP DỮ LIỆU MÔN HỌC
SELECT * FROM MONHOC
INSERT INTO MONHOC
VALUES ('CSDL',N'Cơ sở dữ liệu',3,'TKTH'),
('CSLT',N'Cơ sở lập trình',3,'TKTH'),
('KTVM',N'Kinh tế vi mô',3,'QTKD'),
('MKCB',N'Marketing căn bản',3,'MKT'),
('KTTC',N'Kế toán tài chính',3,'KT'),
('THUD',N'Tin học ứng dụng',3,'TKTH')

-- nhập dữ liệu học phần 
SELECT * FROM HOCPHAN
INSERT INTO HOCPHAN
VALUES ('2111',1,2021,N'Uyên Nhi','CSDL'),
('2021',2,2020,N'Thu Thảo','CSLT'),
('2122',2,2021,N'Minh Hoàng','KTVM'),
('2211',1,2022,N'Châu Linh','MKCB'),
('1922',2,2019,N'Phương Nam','KTTC'),
('2011',1,2020,N'Đình Vấn','THUD')
--Nhập dữ liệu bảng điều kiện
SELECT * FROM DIEUKIEN
INSERT INTO DIEUKIEN
VALUES ('CSLT','CSDL'),
('MKCB','KTVM'),
('KTTC','MKCB')
-- NHẬP DỮ LIỆU KETQUA
SELECT * FROM KETQUA
INSERT INTO KETQUA
VALUES ('SV001','2111',9.0),
('SV002','2021',3.0),
('SV002','2122',7.0),--chưa nhập được--
('SV003','2122',7.0),
('SV004','2211',6.0),
('SV004','1922',5.0),--chưa nhập được--
('SV005','2011',3.0),
('SV005','2111',6.0),--chưa nhập được--
('SV006','2111',4.0),
('SV010','2011',8.0),
('SV010','2021',7.0)--chưa nhập được--

--NHẬP DỮ LIỆU
--INSERT INTO TÊN BẢNG [THUỘC TÍNH] VALUES [DỮ LIỆU THEO THỨ TỰ THUỘC TÍNH]

--NHẬP DỮ LIỆU CÓ THUỘC TÍNH
INSERT INTO KHOA(TENKHOA, MAKHOA, NAMTHANHLAP)
VALUES(N'THỐNG KÊ TIN HỌC','TKTH',1995)

INSERT INTO SINHVIEN
VALUES('SV001',N'Nguyễn Trần Hoài Thương',3,'TKTH')
GO
--THÊM CỘT
ALTER TABLE KHOA ADD SONAM INT
--XÓA CỘT
ALTER TABLE KHOA DROP SONAM
--SỬA CỘT
ALTER TABLE KHOA ALTER COLUMN TENKHOA VARCHAR(50)
--THÊM RÀNG BUỘC TOÀN VẸN: PRIMARY KEY, FOREIGN KEY,UNIQUE, CHECK, NOTNULL, DEFAULT
ALTER TABLE KHOA ADD 
CONSTRAINT UN_KHOA UNIQUE(TENKHOA),
CONSTRAINT CK_NAMTL CHECK NAMTHANHLAP<YEAR(GETDATE)

--Trước khi xóa bảng, xóa ràng buộc toàn vẹn
--thêm ngaysinh datetime SINHVIEN
--KETQUA THÊM XẾP LOAI
-- CHỈNH SỬA MÃ SINH VIÊN VARCHAR(8) THÀNH VARCHAR(10)

ALTER TABLE SINHVIEN ADD NGAYSINH DATETIME
GO
ALTER TABLE KETQUA ADD XEPLOAI NVARCHAR(20)
GO
ALTER TABLE KETQUA DROP CONSTRAINT FK_KQ1
ALTER TABLE KETQUA DROP CONSTRAINT PK_KQUA
ALTER TABLE KETQUA ALTER COLUMN MASV VARCHAR(10) NOT NULL
GO
--
INSERT INTO KHOA VALUES ()
GO

-- SỬA DỮ LIỆU
/*UPDATE <TÊN BẢNG>
SET THUỘC_TÍNH 1, THUỘC TÍNH 2
WHERE <ĐIỀU KIỆN>*/
UPDATE KHOA
SET NAMTHANHLAP =1994
WHERE MAKHOA='QTKD'

UPDATE KHOA
SET MAKHOA='QTKD', NAMTHANHLAP=1992
WHERE TENKHOA=''

UPDATE KETQUA
SET XEPLOAI=
CASE
	WHEN DIEM>=8.5 THEN N'GIOI'
	WHEN DIEM>=7 THEN N'KHA'
END
--XÓA DỮ LIỆU
--DETELE FROM <TÊN BẢNG> WHERE
DETELE FROM KHOA WHERE MAKHOA='TMDT'
SELECT * FROM SINHVIEN
go
--cHO BIẾT ĐIỂM TRUNG BÌNH CỦA TỪNG SINH VIÊN 
SELECT SV.MASV,TENSV, AVG(DIEM) DIEMTB
FROM SINHVIEN SV, KETQUA K
WHERE SV.MASV=K.MASV 
GROUP BY SV.MASV, TENSV
GO
-- 
SELECT SV.MASV,TENSV, DIEM
FROM SINHVIEN SV, KETQUA K, (SELECT SV.MASV, AVG(DIEM) DIEMTB FROM KETQUA K, SINHVIEN SV WHERE  SV.MASV=K.MASV  GROUP BY K.MASV) D
WHERE SV.MASV=K.MASV AND D.DIEMTB=K.DIEM

GO
--CHO BIẾT TỔNG SỐ SV CỦA MỖI KHOA
SELECT K.MAKHOA, K.TENKHOA, COUNT(MASV) SOLUONGSV
FROM SINHVIEN S, KHOA K
WHERE S.MAKHOA=K.MAKHOA
GROUP BY K.MAKHOA, TENKHOA
ORDER BY COUNT(MASV)
GO
--CHO BIẾT SỐ LƯỢNG MÔN HỌC SINHVIEN ĐÃ HỌC
SELECT S.MASV, TENSV, COUNT(S.MASV) SOLUONGMH
FROM SINHVIEN S, KETQUA K
WHERE S.MASV=K.MASV
GROUP BY S.MASV, TENSV
GO
-- TÌM NHỮNG SINH VIÊN CÓ ĐIỂM TB LỚN HƠN HOẶC BẰNG 7
SELECT SV.MASV,TENSV, AVG(DIEM) DIEMTB
FROM SINHVIEN SV, KETQUA K
WHERE SV.MASV=K.MASV 
GROUP BY SV.MASV, TENSV 
HAVING AVG(DIEM)>=7
GO
-- NHỮNG SV CÓ ĐIỂM TRUNG BÌNH BẰNG ĐIỂM TB CỦA 'TRƯƠNG THẾ SANG'
SELECT SV.MASV,TENSV, AVG(DIEM) DIEMTB
FROM SINHVIEN SV, KETQUA K
WHERE SV.MASV=K.MASV AND TENSV!=N'NGUYỄN THẾ BÌNH'
GROUP BY SV.MASV, TENSV 
HAVING AVG(DIEM)=
(SELECT AVG(DIEM) DIEMTB
FROM SINHVIEN SV JOIN KETQUA K ON SV.MASV=K.MASV
WHERE TENSV=N'NGUYỄN THẾ BÌNH'
GROUP BY SV.MASV, TENSV)
GO
--TÌM SINHVIEN CÓ ĐIỂM TB THẤP NHẤT
SELECT SV.MASV,TENSV,AVG(DIEM) DIEMTB
FROM SINHVIEN SV JOIN KETQUA K ON SV.MASV=K.MASV
GROUP BY SV.MASV, TENSV
HAVING AVG(DIEM)<=ALL
(SELECT AVG(DIEM) DIEMTB
FROM SINHVIEN SV JOIN KETQUA K ON SV.MASV=K.MASV
GROUP BY SV.MASV, TENSV)
GO
-- CHO BIẾT SINHVIEN ĐÃ HỌC TẤT CẢ CÁC MÔN CỦA KHOA THỐNG KÊ TIN HỌC
SELECT SV.MASV, TENSV,  COUNT(M.MAMH) SOLUONG
FROM SINHVIEN SV, KETQUA KQ, HOCPHAN H, MONHOC M, KHOA K
WHERE SV.MASV=KQ.MASV AND KQ.MAHP=H.MAHP AND H.MAMH=M.MAMH AND K.MAKHOA = SV.MAKHOA AND TENKHOA=N'THỐNG KÊ TIN HỌC'
GROUP BY SV.MASV, TENSV
HAVING COUNT(M.MAMH)=
(SELECT COUNT(MAMH)
FROM KHOA K JOIN MONHOC M ON M.MAKHOA=K.MAKHOA
WHERE TENKHOA=N'THỐNG KÊ TIN HỌC')
GO
